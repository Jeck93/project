<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Refresh Issue - PWA KB</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Refresh Issue - PWA KB</h1>
        <p>Tool ini membantu mendiagnosis dan memperbaiki masalah refresh yang mengambil data dari spreadsheet lama.</p>

        <!-- Current Status -->
        <div class="section info">
            <h3>üìä Status Saat Ini</h3>
            <div id="currentStatus">
                <p>‚è≥ Memuat status...</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="section">
            <h3>üõ†Ô∏è Aksi Perbaikan</h3>
            <button onclick="clearCacheAndFix()" id="clearBtn">üßπ Bersihkan Cache & Perbaiki URL</button>
            <button onclick="testConnection()" id="testBtn">üîç Test Koneksi ke URL Baru</button>
            <button onclick="forceRefresh()" id="refreshBtn">üîÑ Force Refresh Data</button>
            <button onclick="showDetailedDiagnostic()" id="diagBtn">üî¨ Diagnostic Lengkap</button>
        </div>

        <!-- Results -->
        <div class="section">
            <h3>üìã Hasil</h3>
            <div id="results"></div>
        </div>

        <!-- Console Log -->
        <div class="section">
            <h3>üìù Console Log</h3>
            <div id="consoleLog" class="log"></div>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="js/config.js"></script>
    <script src="js/sheets-api.js"></script>
    <script>
        // URL dan ID yang benar
        const CORRECT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbkVQyK7Ur1__izMxhxAkC8DJOnHKV5_qAkLfgko98M8KaT3APfrNpyq5Xq6xbzZn5/exec';
        const CORRECT_SPREADSHEET_ID = '1VxDv48i3Sx5pNBid1sZOeSCh2sNldBGJgEsUMFnud6g';

        // Console logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('consoleLog');
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0f0';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('consoleLog').innerHTML = '';
        }

        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            resultsDiv.innerHTML += `<div class="section ${className}">${message}</div>`;
        }

        // Load current status
        function loadCurrentStatus() {
            const statusDiv = document.getElementById('currentStatus');
            let html = '';

            // Check CONFIG
            if (typeof CONFIG !== 'undefined') {
                html += `<p>‚úÖ CONFIG loaded</p>`;
                html += `<p>üìù CONFIG.GOOGLE_SCRIPT_URL: <code>${CONFIG.GOOGLE_SCRIPT_URL}</code></p>`;
                html += `<p>üìù CONFIG.SPREADSHEET_ID: <code>${CONFIG.SPREADSHEET_ID}</code></p>`;
                
                if (CONFIG.GOOGLE_SCRIPT_URL === CORRECT_SCRIPT_URL) {
                    html += `<p>‚úÖ CONFIG URL is CORRECT</p>`;
                } else {
                    html += `<p>‚ùå CONFIG URL is WRONG</p>`;
                }
            } else {
                html += `<p>‚ùå CONFIG not loaded</p>`;
            }

            // Check localStorage
            const savedUrl = localStorage.getItem('googleScriptUrl');
            if (savedUrl) {
                html += `<p>üìù localStorage URL: <code>${savedUrl}</code></p>`;
                if (savedUrl === CORRECT_SCRIPT_URL) {
                    html += `<p>‚úÖ localStorage URL is CORRECT</p>`;
                } else {
                    html += `<p>‚ùå localStorage URL is WRONG</p>`;
                }
            } else {
                html += `<p>‚ö†Ô∏è No URL in localStorage</p>`;
            }

            // Check SheetsAPI
            if (typeof window.sheetsAPI !== 'undefined') {
                html += `<p>‚úÖ SheetsAPI initialized</p>`;
                html += `<p>üìù SheetsAPI baseUrl: <code>${window.sheetsAPI.baseUrl}</code></p>`;
                
                if (window.sheetsAPI.baseUrl === CORRECT_SCRIPT_URL) {
                    html += `<p>‚úÖ SheetsAPI URL is CORRECT</p>`;
                } else {
                    html += `<p>‚ùå SheetsAPI URL is WRONG</p>`;
                }
            } else {
                html += `<p>‚ùå SheetsAPI not initialized</p>`;
            }

            statusDiv.innerHTML = html;
        }

        // Clear cache and fix URLs
        async function clearCacheAndFix() {
            const btn = document.getElementById('clearBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Membersihkan...';

            try {
                log('üßπ Memulai pembersihan cache...', 'info');

                // 1. Clear localStorage
                log('1. Membersihkan localStorage...', 'info');
                const oldUrl = localStorage.getItem('googleScriptUrl');
                if (oldUrl) {
                    log(`   URL lama: ${oldUrl}`, 'warning');
                }
                localStorage.removeItem('googleScriptUrl');
                localStorage.setItem('googleScriptUrl', CORRECT_SCRIPT_URL);
                log(`   URL baru: ${localStorage.getItem('googleScriptUrl')}`, 'success');

                // 2. Clear sessionStorage
                log('2. Membersihkan sessionStorage...', 'info');
                sessionStorage.clear();
                log('   ‚úÖ sessionStorage dibersihkan', 'success');

                // 3. Update CONFIG
                log('3. Memperbarui CONFIG...', 'info');
                if (typeof CONFIG !== 'undefined') {
                    CONFIG.GOOGLE_SCRIPT_URL = CORRECT_SCRIPT_URL;
                    CONFIG.SPREADSHEET_ID = CORRECT_SPREADSHEET_ID;
                    log('   ‚úÖ CONFIG diperbarui', 'success');
                } else {
                    log('   ‚ö†Ô∏è CONFIG tidak tersedia', 'warning');
                }

                // 4. Reinitialize SheetsAPI
                log('4. Reinitialize SheetsAPI...', 'info');
                if (typeof SheetsAPI !== 'undefined') {
                    window.sheetsAPI = new SheetsAPI();
                    log(`   ‚úÖ SheetsAPI URL: ${window.sheetsAPI.baseUrl}`, 'success');
                } else {
                    log('   ‚ö†Ô∏è SheetsAPI class tidak tersedia', 'warning');
                }

                // 5. Clear IndexedDB
                log('5. Membersihkan IndexedDB...', 'info');
                try {
                    const deleteReq = indexedDB.deleteDatabase('KBDataDB');
                    deleteReq.onsuccess = () => log('   ‚úÖ IndexedDB dibersihkan', 'success');
                    deleteReq.onerror = () => log('   ‚ö†Ô∏è Gagal membersihkan IndexedDB', 'warning');
                } catch (error) {
                    log(`   ‚ö†Ô∏è Error IndexedDB: ${error.message}`, 'warning');
                }

                log('üéâ Pembersihan cache selesai!', 'success');
                showResult('‚úÖ Cache berhasil dibersihkan dan URL diperbarui!', 'success');
                
                // Reload status
                loadCurrentStatus();

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                showResult(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üßπ Bersihkan Cache & Perbaiki URL';
            }
        }

        // Test connection
        async function testConnection() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Testing...';

            try {
                log('üîç Testing koneksi ke URL yang benar...', 'info');
                log(`URL: ${CORRECT_SCRIPT_URL}`, 'info');

                const testUrl = CORRECT_SCRIPT_URL + '?action=test&callback=testCallback&_t=' + Date.now();
                
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        log('‚ùå Test timeout (10 detik)', 'error');
                        showResult('‚ùå Test timeout - URL mungkin tidak valid atau Google Apps Script belum di-deploy', 'error');
                        cleanup();
                        reject(new Error('Timeout'));
                    }, 10000);

                    const cleanup = () => {
                        clearTimeout(timeout);
                        if (script && script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        if (window.testCallback) {
                            delete window.testCallback;
                        }
                    };

                    window.testCallback = function(data) {
                        log('‚úÖ Test berhasil!', 'success');
                        log(`Response: ${JSON.stringify(data)}`, 'success');
                        showResult('‚úÖ Koneksi berhasil! Google Apps Script merespons dengan benar.', 'success');
                        cleanup();
                        resolve(data);
                    };

                    const script = document.createElement('script');
                    script.onerror = () => {
                        log('‚ùå Script load error', 'error');
                        showResult('‚ùå Script load error - Periksa URL Google Apps Script', 'error');
                        cleanup();
                        reject(new Error('Script load error'));
                    };

                    script.src = testUrl;
                    document.head.appendChild(script);
                });

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                showResult(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Test Koneksi ke URL Baru';
            }
        }

        // Force refresh data
        async function forceRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Refreshing...';

            try {
                log('üîÑ Force refresh data...', 'info');

                if (!window.sheetsAPI) {
                    log('‚ö†Ô∏è SheetsAPI tidak tersedia, inisialisasi...', 'warning');
                    if (typeof SheetsAPI !== 'undefined') {
                        window.sheetsAPI = new SheetsAPI();
                        log('‚úÖ SheetsAPI diinisialisasi', 'success');
                    } else {
                        throw new Error('SheetsAPI class tidak tersedia');
                    }
                }

                log(`üì° Menggunakan URL: ${window.sheetsAPI.baseUrl}`, 'info');

                const result = await window.sheetsAPI.getAllData();
                
                if (result && result.success) {
                    log(`‚úÖ Data berhasil diambil: ${result.data ? result.data.length : 0} records`, 'success');
                    showResult(`‚úÖ Data berhasil di-refresh! Ditemukan ${result.data ? result.data.length : 0} records.`, 'success');
                } else {
                    log(`‚ùå Gagal mengambil data: ${result ? result.error : 'Unknown error'}`, 'error');
                    showResult(`‚ùå Gagal mengambil data: ${result ? result.error : 'Unknown error'}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                showResult(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Force Refresh Data';
            }
        }

        // Show detailed diagnostic
        function showDetailedDiagnostic() {
            log('üî¨ Menjalankan diagnostic lengkap...', 'info');
            
            let diagnostic = '<h4>üî¨ Diagnostic Lengkap</h4>';
            
            // Browser info
            diagnostic += '<h5>üåê Browser Info</h5>';
            diagnostic += `<p>User Agent: ${navigator.userAgent}</p>`;
            diagnostic += `<p>Online: ${navigator.onLine}</p>`;
            diagnostic += `<p>URL saat ini: ${window.location.href}</p>`;
            
            // JavaScript objects
            diagnostic += '<h5>üì¶ JavaScript Objects</h5>';
            diagnostic += `<p>CONFIG available: ${typeof CONFIG !== 'undefined'}</p>`;
            diagnostic += `<p>SheetsAPI class available: ${typeof SheetsAPI !== 'undefined'}</p>`;
            diagnostic += `<p>window.sheetsAPI available: ${typeof window.sheetsAPI !== 'undefined'}</p>`;
            
            // Storage
            diagnostic += '<h5>üíæ Storage</h5>';
            diagnostic += `<p>localStorage keys: ${Object.keys(localStorage).join(', ')}</p>`;
            diagnostic += `<p>sessionStorage keys: ${Object.keys(sessionStorage).join(', ')}</p>`;
            
            // URLs comparison
            diagnostic += '<h5>üîó URLs Comparison</h5>';
            diagnostic += `<p><strong>Expected URL:</strong><br><code>${CORRECT_SCRIPT_URL}</code></p>`;
            
            if (typeof CONFIG !== 'undefined') {
                diagnostic += `<p><strong>CONFIG URL:</strong><br><code>${CONFIG.GOOGLE_SCRIPT_URL}</code></p>`;
                diagnostic += `<p>Match: ${CONFIG.GOOGLE_SCRIPT_URL === CORRECT_SCRIPT_URL ? '‚úÖ' : '‚ùå'}</p>`;
            }
            
            const savedUrl = localStorage.getItem('googleScriptUrl');
            if (savedUrl) {
                diagnostic += `<p><strong>localStorage URL:</strong><br><code>${savedUrl}</code></p>`;
                diagnostic += `<p>Match: ${savedUrl === CORRECT_SCRIPT_URL ? '‚úÖ' : '‚ùå'}</p>`;
            }
            
            if (window.sheetsAPI) {
                diagnostic += `<p><strong>SheetsAPI URL:</strong><br><code>${window.sheetsAPI.baseUrl}</code></p>`;
                diagnostic += `<p>Match: ${window.sheetsAPI.baseUrl === CORRECT_SCRIPT_URL ? '‚úÖ' : '‚ùå'}</p>`;
            }
            
            showResult(diagnostic, 'info');
            log('‚úÖ Diagnostic lengkap selesai', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Debug tool loaded', 'success');
            loadCurrentStatus();
        });
    </script>
</body>
</html>